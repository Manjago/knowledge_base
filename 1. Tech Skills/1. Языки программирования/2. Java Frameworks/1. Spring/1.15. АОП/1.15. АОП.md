# Аспектно-ориентированное программирование
## АОП
Термином АОП нередко обозначают инструментальные средства  для реализации сквозной функциональности.<br/>
_Козмина Ю., Харроп Р., Шефер К., Хо К., Spring 5 для профессионалов. Стр. 307_

##  АОП и ООП
Важно понимать, что АОП дополняет ООП, а не соперничает с ним. <br/>
ООП очень хорошо подходит для обширного ряда задач, которые приходится решать программистам. Но если обратить к примеру log'ирования, то станет очевидно, что когда дело доходит до реализации сквозной функциональности в крупных масштабах, то возможностей ООП недостаточно.<br/>
С другой стороны, более разумный подход предусматривает применение АОП для решения определенных задач, связанных со сквозной функциональностью.<br/>
_Козмина Ю., Харроп Р., Шефер К., Хо К., Spring 5 для профессионалов. Стр. 307_

## Основные понятия АОП
* **Точки соединения (joinpoint)**. Это вполне определенная точка во время выполнения приложения (к примеру, вызов метода, инициализация класса).  Определяют места в классах, где можно вставить дополнительную логику.
* **Советы (advice)**. Фрагмнт кода, который должен выполняться в отдельной точке соединения (могут быть предшествующими или последжовательными)
* **Срезы (pointcut)**. Совокупность точек соединения, предназначенная для определения момента, когда следует выполнить совет
* **Аспекты (aspect)**. Сочетания совета и срезов, инкапсулированных в классе
* **Связывание (weawing)**. Процесс вставки спектов в определенном месте прикладного кода (статически во время сборки или динамически во время выполнения)
* **Цель (target)**. Объект, поток исполнения которого изменяется каким-нибудь процессом АОП
* **Внедрение (introduction)**. Процесс, посредством которого можно изменить структуру объекта, введяв него дополнительные методы или поля.

_Козмина Ю., Харроп Р., Шефер К., Хо К., Spring 5 для профессионалов. Стр. 309-310_

## Реализация статического АОП
При статическом АОП связывание образует еще одну стадию в процессе сборки приложения.<br/>
В терминах Java процесс связывания при статической реализации АОП предусматривает модификацию действительного байт-кода приложения, имзеняя и расширяя прикладной код должным образом.<br/>
Это _эффективный механизм, поскольку_ конечным результатом оказывается просто байт-код Java, избавляя от необходимости предпринимать специальные меры на стадии выполнения.<br/>
_Недостаток:_ любые изменения. вносимые в аспект требуют обязательной перекомпиляции.<br/>
_Козмина Ю., Харроп Р., Шефер К., Хо К., Spring 5 для профессионалов. Стр. 310-311_

## Реализация динамического АОП
Процесс связывания происходит во время выполнения.<br/>
В Spring для этого применяется создание заместителей для всех целевых объектов.<br/>
_Недостаток:_ выполнение уступае статическому АОП<br/>
_Козмина Ю., Харроп Р., Шефер К., Хо К., Spring 5 для профессионалов. Стр. 311_

## АОП в Spring
Реализация АОП в Spring можно представить как состоящую из двух логических частей.<br/>
Первая часть содержит ядро АОП, обеспечивающее полностью развязанные, чисто программные функциональные возможности АОП, иначе называемые _Spring AOP API_<br/>
Вторая часть реализации АОП содержит ряд служб каркаса, упрощающих применение АОП в приложении<br/>
_Козмина Ю., Харроп Р., Шефер К., Хо К., Spring 5 для профессионалов. Стр. 311-312_

## Альянс АОП и Spring
[Альянс АОП](aopalliance.sourceforge.net) - это результат совместных усилий участников многих проектов АОП с открытым кодом по определению стандартного набора интерфейсов для реализации АОП.<br/>
Где это возможно, Spring применяет интерфейсы, определенные Альянсом АОП<br/>
_Козмина Ю., Харроп Р., Шефер К., Хо К., Spring 5 для профессионалов. Стр. 312_

## MethodInterceptor, MethodInvocation и создание proxy с помощью ProxyFactory
`MethodInterceptor` - это стандартный интерфейс от Альянса АОП, предназначенный для реализации совета, окружающего точки соединения вызовов методов.<br/>
`MethodInvocation` - это вызов метода, снабжаемого советом. С помощью этого объекта можно контролировать момент выполнения метода и получать доступ к информации метода (к примеру о параметрах)<br/>
С помощью `ProxyFactory` можно создать proxy на основе нужного объекта с применением аспекта<br/>
[Пример](../examples/spring/src/main/java/ru/akhitev/kb/spring/aop)
```java
public class Ship {
    public void jump(String targetStarSystem) {
        System.out.println("preparing for jump");
        System.out.println("jump");
    }
}
```
```java
public class ShipLogger implements MethodInterceptor {

    @Override
    public Object invoke(MethodInvocation invocation) throws Throwable {
        // some logging logic
        return invocation.proceed();
    }
}
```
```java
Ship ship = new Ship();

ProxyFactory proxyFactory = new ProxyFactory();
proxyFactory.addAdvice(new ShipLogger());
proxyFactory.setTarget(ship);

Ship proxyShip = (Ship) proxyFactory.getProxy();
proxyShip.jump("Beta Durany");
```
Вывод
```
[ShipLog] Initiating jump through hyper space.
[ShipLog] Target: java.lang.String arg0
preparing for jump
jump
```
_Козмина Ю., Харроп Р., Шефер К., Хо К., Spring 5 для профессионалов. Стр. 313_

## Ограничение на объекты для АОП
Для реализации АОП в Spring невозможно снабдить советом оконченые классы, поскольку они не могут быть расширены, а следовательно, их нельзя заместить.<br/>
Оконченый класс нельзя заместить и в том случае, есои он не реализует интерфейс<br/>
_Козмина Ю., Харроп Р., Шефер К., Хо К., Spring 5 для профессионалов. Стр. 314_

## Архитектура АОП в Spring
Базовая архитектура АОП в Spring основана на заместителях. Так, если требуется получить экземпляр класса, снабженного советом, то с этой целью придетя получить экземпляр заместителя типа `ProxyFactory`, предоставиви прежде всего конструктору класса `ProxyFactory` все аспекты, которые необходимо привязать к заместителю.<br/>
Применение `ProxyFactory` - чисто программный подход к созданию заместителей в АОП.<br/>
Вместо использованияпрограммного подхода можно положитьсяна механизмы декларативного конфигурирования АОП, предоставляемые в Spring (`ProxyFactoryBean`, пространство имен `aop` и аннотации в стиле `@AspectJ`), которые обеспечат декларативное создание заместителей.<br/>
На стадии выполнения каркас Spring анализирует сквозную функциональность, определенную для компонентов Spring Bean в `ApplicationContext`, и динамически формирует замещающие компоненты Spring bean, которые служат оболочками для целевых компонентов. Вместо непосредственного обращения к целевому компоненту вызывающие компоненты внедряются с помощью замещающего компонента. Затем замещяющий компонент анализирует текущие условия (срез, совет) и соответственно привязывает подходящий совет<br/>
_Козмина Ю., Харроп Р., Шефер К., Хо К., Spring 5 для профессионалов. Стр. 314-315_

## Две реализации в Spring
В самом каркасе Spring поддерживаются две реализации заместителей: динамические заместители JDK и заместители CGLIB.<br/>
По умолчанию, если целевой объект, снабженный советом, реализует какой-нибудь интерфейс, для получения экземпляров заместителей целевого объекта в Spring будет использован динамический заместитель JDK.<br/>
Но если целевой объект, снабженный советом, не реализует интерфейс, то для получения экземпляров заместителей будет применяться библиотека CGLIB<br/>
_Козмина Ю., Харроп Р., Шефер К., Хо К., Spring 5 для профессионалов. Стр. 315_

## Упрощение АОП в Spring
К числу замых заметных упрощений АОП в Spring следует отнести поддержку только одного типа точек соединения, которым является вызов метода.<br/>
_Козмина Ю., Харроп Р., Шефер К., Хо К., Spring 5 для профессионалов. Стр. 315_

## Аспекты в Spring
При реализации АОП в Spring представлен экземпляр класса, реализующего интерфейс `Advisor`. В Spring предоставляются удобные средства реализации `Advisor`, которые можно применять в своих приложениях, без необходимости создания своих реализций.<br/>
У `Advisor` есть подчиненные интерфейсы: `IntroductionAdvisor` и `PointcutAdvisor`<br/>
С помощью `IntroductionAdvisor` можно управлять теми классами, в которых применяется внедрение.<br/>
`PointcutAdvisor` реализуется во всех реализациях `Advisor`, где срезы служат для управления процессом применения совета в точках соединения.<br/>
_Козмина Ю., Харроп Р., Шефер К., Хо К., Spring 5 для профессионалов. Стр. 316_
